<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>(Muslim Nikah Peace Chat)</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.js"></script>
    
    <style>
        :root { --primary: #008069; --bg: #f0f2f5; --white: #fff; --danger: #d32f2f; --success: #25d366; --edit: #1976d2; }
        body { margin: 0; padding: 0; font-family: -apple-system, sans-serif; background: var(--bg); padding-bottom: 90px; padding-top: 60px; overflow-x: hidden; }

        /* Auth Screen */
        #auth-screen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: var(--bg); z-index: 2000; display: flex; flex-direction: column; align-items: center; justify-content: center; overflow-y: auto; }
        .auth-card { background: white; padding: 30px; border-radius: 20px; width: 85%; max-width: 350px; text-align: center; box-shadow: 0 4px 10px rgba(0,0,0,0.1); margin-top: 50px; }
        .auth-toggle { color: var(--primary); cursor: pointer; font-weight: bold; margin-top: 15px; display: inline-block; }

        /* Common Elements */
        .input-text { width: 100%; border: 1px solid #ddd; background: #fff; border-radius: 8px; padding: 12px; margin-bottom: 10px; box-sizing: border-box; }
        .btn-primary { background: var(--primary); color: white; border: none; padding: 10px 20px; border-radius: 20px; font-weight: bold; cursor: pointer; width: 100%; margin-bottom: 10px; }
        .btn-download { background: #333; color: white; border: none; padding: 15px; border-radius: 10px; width: 100%; font-weight: bold; text-decoration: none; display: block; box-sizing: border-box; text-align: center; margin-bottom: 15px; box-shadow: 0 2px 5px rgba(0,0,0,0.2); }

        /* Header */
        .header { position: fixed; top: 0; width: 100%; height: 60px; background: #fff; display: flex; align-items: center; padding-left: 20px; z-index: 1000; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
        .logo { font-size: 22px; font-weight: bold; color: var(--primary); }

        /* Layout */
        .container { max-width: 600px; margin: 0 auto; padding: 10px; }
        .page-section { display: none; }
        .page-section.active { display: block; }
        .card { background: #fff; border-radius: 10px; padding: 15px; margin-bottom: 15px; box-shadow: 0 1px 2px rgba(0,0,0,0.1); width: 100%; box-sizing: border-box; }

        /* --- ADMIN DASHBOARD STYLES --- */
        .section-title { font-size: 14px; font-weight: bold; color: #555; margin: 20px 0 10px 0; border-bottom: 1px solid #ccc; padding-bottom: 5px; }
        
        .user-row, .prod-row, .post-row { 
            display: flex; justify-content: space-between; align-items: flex-start;
            border-bottom: 1px solid #eee; padding: 10px 0; gap: 10px;
        }
        /* Added cursor pointer to user-info for clickability */
        .user-info, .prod-info, .post-info { font-size: 13px; text-align: left; flex: 1; min-width: 0; word-break: break-word; }
        .user-info { cursor: pointer; } 
        .thumb-img { width: 40px; height: 40px; object-fit: cover; border-radius: 5px; margin-right: 8px; flex-shrink: 0; }
        
        .admin-actions { display: flex; flex-direction: column; gap: 5px; flex-shrink: 0; }
        .admin-btn { padding: 5px 8px; font-size: 10px; border-radius: 4px; border: none; cursor: pointer; color: white; width: 65px; text-align: center; }
        
        .btn-add { background: green; }
        .btn-del { background: var(--danger); }
        .btn-edit { background: var(--edit); }
        .btn-wa { background: #25D366; } 
        .btn-approve { background: var(--success); width: 100%; margin-top: 5px; }
        .btn-reject { background: var(--danger); }
        
        .admin-badge { background: #ffeb3b; padding: 2px 5px; font-size: 10px; border-radius: 3px; font-weight: bold; color: black; display: inline-block; margin-top: 2px; }
        .payment-request-box { background: #e8f5e9; border: 1px solid #c8e6c9; padding: 10px; margin-bottom: 5px; border-radius: 8px; font-size: 13px; }
        .settings-box { background: #e3f2fd; padding: 10px; border-radius: 8px; border: 1px solid #bbdefb; margin-bottom: 10px; }

        /* Profile Styles */
        .cover-photo-container { width: 100%; height: 150px; background-color: #ddd; border-radius: 10px 10px 0 0; position: relative; background-size: cover; background-position: center; }
        .profile-pic-container { width: 100px; height: 100px; border-radius: 50%; background-color: #fff; border: 4px solid white; position: absolute; bottom: -40px; left: 20px; background-size: cover; background-position: center; background-image: url('https://via.placeholder.com/100'); }
        .profile-info { margin-top: 50px; padding: 0 15px 15px 15px; }
        .edit-icon { position: absolute; right: 10px; bottom: 10px; background: rgba(0,0,0,0.6); color: white; padding: 5px; border-radius: 50%; cursor: pointer; font-size: 12px; }
        .admin-msg-alert { background: #ffebee; border: 1px solid #ef9a9a; color: #c62828; padding: 10px; border-radius: 8px; margin-bottom: 10px; font-size: 13px; display: flex; justify-content: space-between; align-items: center; }

        /* Post Styles */
        .post-header { display: flex; align-items: center; gap: 10px; margin-bottom: 10px; }
        
        /* --- CHANGED: Style for line breaks and preserving spaces in posts --- */
        .post-content-text { 
            white-space: pre-wrap;
        }
        /* -------------------------------------------------------------------- */

        .avatar-img { width: 40px; height: 40px; border-radius: 50%; object-fit: cover; background: #ccc; cursor: pointer; }
        .username-link { font-weight: bold; cursor: pointer; color: #000; text-decoration: none; }
        .post-img { width: 100%; border-radius: 10px; margin-top: 5px; max-height: 400px; object-fit: cover; }
        .action-row { display: flex; justify-content: space-around; margin-top: 10px; border-top: 1px solid #f0f0f0; padding-top: 10px; }
        .act-btn { background: none; border: none; cursor: pointer; font-weight: 600; color: #555; display: flex; align-items: center; gap: 5px; }
        .act-btn.starred { color: #f5c518; }
        .act-btn.delete { color: var(--danger); border: 1px solid var(--danger); border-radius: 15px; padding: 4px 12px; font-size: 12px; }
        .comment-box { display: none; margin-top: 10px; background: #fafafa; padding: 10px; border-radius: 10px; }

        /* Market & Friends */
        .market-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        .product-card { background: white; padding: 10px; border-radius: 10px; display: flex; flex-direction: column; cursor: pointer; box-shadow: 0 1px 2px rgba(0,0,0,0.1); width: 100%; box-sizing: border-box; }
        .prod-img { width: 100%; height: 140px; object-fit: cover; border-radius: 8px; background: #eee; }
        .friends-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin-top: 10px; }
        .friend-card { text-align: center; cursor: pointer; }
        .friend-img { width: 60px; height: 60px; border-radius: 50%; object-fit: cover; background: #eee; margin: 0 auto; display: block; border: 2px solid #fff; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .friend-name { font-size: 12px; font-weight: bold; margin-top: 5px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }

        /* Nav */
        .bottom-nav { position: fixed; bottom: 0; width: 100%; height: 70px; background: #fff; display: flex; justify-content: space-evenly; align-items: center; border-top: 1px solid #eee; z-index: 1000; }
        .nav-btn { width: 50px; height: 50px; border-radius: 50%; border: none; background: #f0f0f0; display: flex; justify-content: center; align-items: center; cursor: pointer; }
        .nav-btn.active { background: var(--primary); }
        .nav-btn.active svg { fill: white; }
        .hidden { display: none !important; }
        
        /* Modals */
        .modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 3000; display: none; align-items: center; justify-content: center; }
        .modal-content { background: white; width: 90%; max-width: 450px; border-radius: 15px; padding: 20px; position: relative; max-height: 80vh; overflow-y: auto; text-align: left; }
        .close-modal { position: absolute; top: 10px; right: 15px; font-size: 24px; cursor: pointer; }
        .pay-alert { text-align: center; }
        .pay-btn { background: #673ab7; color: white; width: 100%; padding: 12px; border: none; border-radius: 20px; font-weight: bold; margin-top: 10px; cursor: pointer; }
        .btn-confirm { background: #2e7d32; color: white; width: 100%; padding: 12px; border: none; border-radius: 20px; font-weight: bold; margin-top: 10px; cursor: pointer; }
        .credit-badge { background: #e0f2f1; color: var(--primary); padding: 5px 10px; border-radius: 15px; font-size: 12px; font-weight: bold; display:inline-block; margin-bottom:10px; }
    </style>
</head>
<body>

    <!-- AUTH SCREEN -->
    <div id="auth-screen">
        <div id="login-box" class="auth-card">
            <h2 style="color:var(--primary)">Login</h2>
            <input type="email" id="login-email" class="input-text" placeholder="Email">
            <input type="password" id="login-pass" class="input-text" placeholder="Password">
            <button class="btn-primary" onclick="handleLogin()">Login</button>
            <p class="auth-toggle" onclick="toggleAuth('register')">Create New Account</p>
            <p id="l-msg" style="color:red; font-size:12px; margin-top:10px;"></p>
        </div>
        <div id="register-box" class="auth-card hidden">
            <h2 style="color:var(--primary)">Register</h2>
            <input type="text" id="reg-name" class="input-text" placeholder="Full Name (Required)">
            <input type="email" id="reg-email" class="input-text" placeholder="Email">
            <input type="tel" id="reg-phone" class="input-text" placeholder="Phone Number (Important)">
            <input type="password" id="reg-pass" class="input-text" placeholder="Password">
            <button class="btn-primary" onclick="handleRegister()">Register</button>
            <p class="auth-toggle" onclick="toggleAuth('login')">Already have an account? Login</p>
            <p id="r-msg" style="color:red; font-size:12px; margin-top:10px;"></p>
        </div>
    </div>

    <!-- HEADER -->
    <div class="header">
        <div class="logo">Peace Chat</div>
        <button style="margin-left:auto; margin-right:20px; color:red; border:none; background:none; font-weight:bold;" onclick="logout()">Logout</button>
    </div>

    <!-- MAIN CONTAINER -->
    <div class="container">

        <!-- 1. HOME FEED -->
        <div id="home" class="page-section active">
            <div id="feed-container"></div>
        </div>

        <!-- 2. PROFILE -->
        <div id="profile" class="page-section">
            <div class="card" style="padding:0; overflow:hidden;">
                <div class="cover-photo-container" id="cover-display">
                    <label id="edit-cover-btn" class="edit-icon hidden">
                        üì∑ Edit <input type="file" onchange="uploadCover(this)" hidden>
                    </label>
                </div>
                <div style="position:relative;">
                    <div class="profile-pic-container" id="dp-display">
                        <label id="edit-dp-btn" class="edit-icon hidden">
                            ‚úèÔ∏è <input type="file" onchange="uploadDP(this)" hidden>
                        </label>
                    </div>
                </div>
                <div class="profile-info">
                    <h2 id="profile-name">User Name</h2>
                    <div id="profile-actions" style="margin-top:10px;"></div>
                </div>
            </div>
            <!-- Admin Message Display Area -->
            <div id="admin-message-area"></div>
            
            <div class="card">
                <h3>My Friends</h3>
                <div id="profile-friends-list" class="friends-grid"></div>
            </div>
            <div id="profile-posts-area"></div>
        </div>

        <!-- 3. MARKETPLACE -->
        <div id="market" class="page-section">
            <div class="card">
                <h3>Sell Item</h3>
                <input type="text" id="pTitle" class="input-text" placeholder="Title">
                <input type="number" id="pPrice" class="input-text" placeholder="Price">
                <select id="pCategory" class="input-text"><option>Electronics</option><option>Vehicle</option><option>Other</option></select>
                <textarea id="pDesc" class="input-text" placeholder="Description"></textarea>
                <label style="color:var(--primary); cursor:pointer;">+ Upload Image <input type="file" id="prodFile" hidden accept="image/*"></label>
                <p id="market-img-status" style="font-size:12px; color:green;"></p>
                <button class="btn-primary" onclick="submitProduct()">Post Ad</button>
            </div>
            <div id="market-container" class="market-grid"></div>
        </div>

        <!-- 4. MENU -->
        <div id="menu" class="page-section">
            <!-- ADMIN DASHBOARD -->
            <div id="admin-dashboard" class="card hidden" style="border: 2px solid red; background:#fff5f5;">
                <h2 style="color:red;">üëë Admin Dashboard</h2>
                
                <div class="settings-box">
                    <b>‚öôÔ∏è Payment Settings</b>
                    <div style="display:flex; gap:5px; margin-top:5px;">
                        <input type="number" id="admin-pay-amount" class="input-text" style="margin:0; width:70%;" placeholder="Current Amount">
                        <button class="btn-primary" style="width:30%; margin:0; padding:5px;" onclick="saveSettings()">Save</button>
                    </div>
                </div>

                <div class="section-title">üîî Payment Requests</div>
                <div id="admin-payment-list">No pending payments.</div>
                
                <div class="section-title">üñºÔ∏è Manage Posts</div>
                <div id="admin-post-list">Loading posts...</div>

                <div class="section-title">üì¶ Market Products</div>
                <div id="admin-product-list">Loading products...</div>

                <div class="section-title">üë• All Users</div>
                <div id="admin-user-list">Loading users...</div>
            </div>

            <div class="card">
                <h2>Menu</h2>
                <!-- APK LINK -->
                <a href="https://rashikarashika966-pixel.github.io/Muslim_PeaceChat.apk/Muslim_PeaceChat.apk" target="_blank" class="btn-download">
                    ‚¨áÔ∏è Download Android App
                </a>
                
                <div style="padding:15px; border-bottom:1px solid #eee;" onclick="openMyProfile()">My Profile <span>></span></div>
                <div style="padding:15px; border-bottom:1px solid #eee;" onclick="showFriendRequests()">Friend Requests <span>></span></div>
                <div style="padding:15px; border-bottom:1px solid #eee; color:red;" onclick="logout()">Logout</div>
            </div>
            <div id="req-list-container" class="card hidden"></div>
        </div>

    </div>

    <!-- MODALS -->
    <!-- Product View -->
    <div id="product-modal" class="modal">
        <div class="modal-content">
            <span class="close-modal" onclick="closeProdModal()">&times;</span>
            <img id="modal-img" src="" style="width:100%; border-radius:10px; margin-bottom:10px;">
            <h2 id="modal-title"></h2>
            <h3 id="modal-price" style="color:green; margin:5px 0;"></h3>
            <p><b>Seller:</b> <span id="modal-seller-name">Loading...</span></p> 
            <p id="modal-desc" style="background:#f9f9f9; padding:10px;"></p>
            <button id="whatsapp-btn" class="btn-primary" style="background:#25D366; margin-top:15px;">üí¨ Message on WhatsApp</button>
        </div>
    </div>

    <!-- Admin Edit Post Modal -->
    <div id="admin-edit-post-modal" class="modal">
        <div class="modal-content">
            <span class="close-modal" onclick="document.getElementById('admin-edit-post-modal').style.display='none'">&times;</span>
            <h3>‚úèÔ∏è Edit Post</h3>
            <input type="hidden" id="edit-post-id">
            <textarea id="edit-post-content" class="input-text" style="height:100px;" placeholder="Post Content"></textarea>
            <button class="btn-primary" onclick="saveAdminPost()">Save Changes</button>
        </div>
    </div>

    <!-- Admin Edit Product Modal -->
    <div id="admin-edit-modal" class="modal">
        <div class="modal-content">
            <span class="close-modal" onclick="document.getElementById('admin-edit-modal').style.display='none'">&times;</span>
            <h3>‚úèÔ∏è Edit Product</h3>
            <input type="hidden" id="edit-p-id">
            <input type="text" id="edit-p-title" class="input-text" placeholder="Title">
            <input type="number" id="edit-p-price" class="input-text" placeholder="Price">
            <select id="edit-p-cat" class="input-text">
                <option>Electronics</option><option>Vehicle</option><option>Other</option>
            </select>
            <textarea id="edit-p-desc" class="input-text" placeholder="Description"></textarea>
            <button class="btn-primary" onclick="saveAdminProduct()">Save Changes</button>
        </div>
    </div>

    <!-- Payment Alert -->
    <div id="payment-modal" class="modal">
        <div class="modal-content pay-alert">
            <span class="close-modal" onclick="document.getElementById('payment-modal').style.display='none'">&times;</span>
            <div style="font-size:40px;">üíé</div>
            <h2>Limit Reached</h2>
            <p>You have <b>0</b> posts remaining.</p>
            <p>Pay <b id="pay-amt-disp">‚Çπ50</b> via UPI to get <b>3 New Posts</b>.</p>
            <button class="pay-btn" onclick="payForPremium()">1. Pay Now</button>
            <br>
            <button class="btn-confirm" onclick="notifyPayment()">2. I Have Paid (Notify Admin)</button>
            <p style="font-size:11px; color:gray; margin-top:10px;">Click "I Have Paid" after successful payment.</p>
        </div>
    </div>

    <!-- NAV -->
    <div class="bottom-nav">
        <button class="nav-btn active" onclick="switchTab('home', this)">üè†</button>
        <button class="nav-btn" onclick="openMyProfile(this)">üë§</button>
        <button class="nav-btn" onclick="switchTab('market', this)">üõçÔ∏è</button>
        <button class="nav-btn" onclick="switchTab('menu', this)">‚ò∞</button>
    </div>

    <script>
        // ===========================================
        //  CONFIG (Admin Login)
        // ===========================================
        const ADMIN_EMAIL = "admin@peacechat.com";
        const ADMIN_UPI = "bmfurniture@ibl";
        
        let GLOBAL_PAY_AMOUNT = "50"; // Default, will load from DB

        const SUPABASE_URL = 'https://wcciwyhsmwgyspqfnkmt.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6IndjY2l3eWhzbXdneXNwcWZua210Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjUwMzAwMjAsImV4cCI6MjA4MDYwNjAyMH0.ENIyks7DDoVjDZjiPMTzJnSFqvRZXT1E-cgvScDWgGo';
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        let currentUserEmail = "";
        let postImgBase64 = null;
        let prodImgBase64 = null;

        // AUTH
        function toggleAuth(v) { document.getElementById('login-box').classList.add('hidden'); document.getElementById('register-box').classList.add('hidden'); document.getElementById(v+'-box').classList.remove('hidden'); }
        async function handleLogin() {
            const email = document.getElementById('login-email').value; const pass = document.getElementById('login-pass').value;
            let { data, error } = await supabase.auth.signInWithPassword({ email, password: pass });
            if (error) document.getElementById('l-msg').innerText = error.message;
            else { currentUserEmail = data.session.user.email; document.getElementById('auth-screen').style.display = 'none'; loadAll(); }
        }
        async function handleRegister() {
            const name = document.getElementById('reg-name').value; const email = document.getElementById('reg-email').value; const phone = document.getElementById('reg-phone').value; const pass = document.getElementById('reg-pass').value;
            if(!name || !email || !pass) { document.getElementById('r-msg').innerText = "All fields required!"; return; }
            const { data, error } = await supabase.auth.signUp({ email, password: pass });
            if(error) { document.getElementById('r-msg').innerText = error.message; }
            else { 
                await supabase.from('profiles').insert({ email: email, full_name: name, phone: phone, posts_left: 1 }); 
                alert("Success! Login now."); toggleAuth('login'); 
            }
        }
        
        async function logout() { 
            await supabase.auth.signOut(); 
            currentUserEmail = "";
            document.getElementById('auth-screen').style.display = 'flex';
            toggleAuth('login');
            document.getElementById('feed-container').innerHTML = "";
            document.getElementById('profile-posts-area').innerHTML = "";
        }

        async function loadAll() { 
            await loadSettings(); // Load Price
            loadFeed(); loadMarket(); 
            if(currentUserEmail === ADMIN_EMAIL) { 
                document.getElementById('admin-dashboard').classList.remove('hidden'); 
                loadAdminDashboard(); 
            } 
        }

        // --- DYNAMIC SETTINGS ---
        async function loadSettings() {
            const { data } = await supabase.from('app_settings').select('value').eq('key', 'payment_amount').single();
            if(data) {
                GLOBAL_PAY_AMOUNT = data.value;
                document.getElementById('pay-amt-disp').innerText = "‚Çπ" + GLOBAL_PAY_AMOUNT;
                document.getElementById('admin-pay-amount').value = GLOBAL_PAY_AMOUNT;
            }
        }

        async function saveSettings() {
            const newAmt = document.getElementById('admin-pay-amount').value;
            if(!newAmt) return;
            const { error } = await supabase.from('app_settings').upsert({ key: 'payment_amount', value: newAmt });
            if(!error) { 
                GLOBAL_PAY_AMOUNT = newAmt; 
                alert("Payment Amount Updated to ‚Çπ" + newAmt); 
            } else {
                alert("Error updating settings.");
            }
        }

        // --- ADMIN DASHBOARD ---
        async function loadAdminDashboard() {
            loadPaymentRequests();
            loadAdminPosts();
            loadAdminProducts();
            loadAdminUsers();
        }

        async function loadPaymentRequests() {
            const list = document.getElementById('admin-payment-list');
            const { data: reqs } = await supabase.from('payment_requests').select('*').order('created_at', {ascending: false});
            
            if (!reqs || reqs.length === 0) { list.innerHTML = "<small>No pending requests</small>"; return; }

            list.innerHTML = "";
            reqs.forEach(r => {
                list.innerHTML += `
                    <div class="payment-request-box">
                        <b>${r.user_email}</b> claims to have paid ‚Çπ${r.amount}.
                        <div style="display:flex; gap:5px; margin-top:5px;">
                            <button class="admin-btn btn-approve" onclick="approvePayment('${r.user_email}', ${r.id})">‚úÖ Approve</button>
                            <button class="admin-btn btn-reject" onclick="rejectPayment('${r.user_email}', ${r.id})">‚ùå Reject</button>
                        </div>
                    </div>
                `;
            });
        }

        async function approvePayment(email, reqId) {
            if(!confirm("Confirm payment?")) return;
            let { data: profile } = await supabase.from('profiles').select('posts_left').eq('email', email).single();
            let current = profile?.posts_left || 0;
            await supabase.from('profiles').update({posts_left: current + 3, admin_message: null}).eq('email', email);
            await supabase.from('payment_requests').delete().eq('id', reqId);
            alert("Credits Added!"); loadPaymentRequests(); loadAdminUsers();
        }

        async function rejectPayment(email, reqId) {
            const msg = prompt("Reason?", "Payment not received.");
            if(!msg) return;
            await supabase.from('profiles').update({ admin_message: msg }).eq('email', email);
            await supabase.from('payment_requests').delete().eq('id', reqId);
            alert("Rejected."); loadPaymentRequests();
        }

        async function loadAdminPosts() {
            const list = document.getElementById('admin-post-list');
            list.innerHTML = "Loading...";
            const { data: posts } = await supabase.from('posts').select('*').order('created_at', {ascending: false});
            if(!posts || posts.length === 0) { list.innerHTML = "<small>No posts.</small>"; return; }
            list.innerHTML = "";
            posts.forEach(p => {
                const img = p.image_url ? `<img src="${p.image_url}" class="thumb-img">` : '<div class="thumb-img" style="background:#eee;"></div>';
                const pStr = encodeURIComponent(JSON.stringify(p));
                list.innerHTML += `<div class="post-row"><div style="display:flex; flex:1; min-width:0;">${img}<div class="post-info"><small>${p.user_email}</small><br><span>${p.content.substring(0, 30)}...</span></div></div><div class="admin-actions"><button class="admin-btn btn-edit" onclick="openAdminEditPost('${pStr}')">Edit</button><button class="admin-btn btn-del" onclick="adminDeletePost(${p.id})">Del</button></div></div>`;
            });
        }
        function openAdminEditPost(str) { const p = JSON.parse(decodeURIComponent(str)); document.getElementById('edit-post-id').value = p.id; document.getElementById('edit-post-content').value = p.content; document.getElementById('admin-edit-post-modal').style.display = 'flex'; }
        async function saveAdminPost() { const id = document.getElementById('edit-post-id').value; const content = document.getElementById('edit-post-content').value; await supabase.from('posts').update({ content: content }).eq('id', id); alert("Post Updated"); document.getElementById('admin-edit-post-modal').style.display = 'none'; loadAdminPosts(); loadFeed(); }
        async function adminDeletePost(id) { if(!confirm("Delete?")) return; await supabase.from('posts').delete().eq('id', id); loadAdminPosts(); loadFeed(); }

        async function loadAdminProducts() {
            const list = document.getElementById('admin-product-list');
            list.innerHTML = "Loading...";
            const { data: products } = await supabase.from('products').select('*').order('created_at', {ascending: false});
            if(!products || products.length === 0) { list.innerHTML = "<small>No products.</small>"; return; }
            list.innerHTML = "";
            products.forEach(p => {
                const pStr = encodeURIComponent(JSON.stringify(p));
                const img = p.image_url || 'https://via.placeholder.com/50';
                list.innerHTML += `<div class="prod-row"><div style="display:flex; flex:1; min-width:0;"><img src="${img}" class="thumb-img"><div class="prod-info"><b>${p.title}</b><br><small>${p.seller}</small></div></div><div class="admin-actions"><button class="admin-btn btn-edit" onclick="openEditProductModal('${pStr}')">Edit</button><button class="admin-btn btn-del" onclick="adminDeleteProduct(${p.id})">Del</button></div></div>`;
            });
        }
        async function adminDeleteProduct(id) { if(!confirm("Remove?")) return; await supabase.from('products').delete().eq('id', id); loadAdminProducts(); loadMarket(); }
        function openEditProductModal(str) { const p = JSON.parse(decodeURIComponent(str)); document.getElementById('edit-p-id').value = p.id; document.getElementById('edit-p-title').value = p.title; document.getElementById('edit-p-price').value = p.price; document.getElementById('edit-p-cat').value = p.category; document.getElementById('edit-p-desc').value = p.description; document.getElementById('admin-edit-modal').style.display = 'flex'; }
        async function saveAdminProduct() { const id = document.getElementById('edit-p-id').value; const title = document.getElementById('edit-p-title').value; const price = document.getElementById('edit-p-price').value; const cat = document.getElementById('edit-p-cat').value; const desc = document.getElementById('edit-p-desc').value; await supabase.from('products').update({ title, price, category: cat, description: desc }).eq('id', id); alert("Product Updated!"); document.getElementById('admin-edit-modal').style.display = 'none'; loadAdminProducts(); loadMarket(); }

        // ‡¥á‡¥µ‡¥ø‡¥ü‡µÜ‡¥Ø‡¥æ‡¥£‡µç ‡¥™‡µç‡¥∞‡¥ß‡¥æ‡¥® ‡¥Æ‡¥æ‡¥±‡µç‡¥±‡¥Ç. user-info-‡¥Ø‡¥ø‡µΩ onclick="openUserProfile('${u.email}')" ‡¥ö‡µá‡µº‡¥§‡µç‡¥§‡µÅ.
        async function loadAdminUsers() {
            const list = document.getElementById('admin-user-list'); list.innerHTML="Loading..."; const { data: users } = await supabase.from('profiles').select('*').order('created_at', {ascending: false}); list.innerHTML = users?.length?"":"<small>None</small>";
            if(users) users.forEach(u => {
                const isMe = u.email === ADMIN_EMAIL;
                // WhatsApp Button Logic
                let waBtn = "";
                if(u.phone) {
                    let ph = u.phone.replace(/\D/g,'');
                    if(ph.length===10) ph="91"+ph;
                    waBtn = `<button class="admin-btn btn-wa" onclick="window.open('https://wa.me/${ph}')">Chat</button>`;
                }

                list.innerHTML += `
                    <div class="user-row">
                        <div class="user-info" onclick="openUserProfile('${u.email}')"> 
                            <b>${u.full_name}</b><br>${u.email}<br>
                            <span class="admin-badge">Posts: ${u.posts_left||0}</span>
                        </div>
                        <div class="admin-actions">
                            ${waBtn}
                            ${!isMe ? `<button class="admin-btn btn-del" onclick="adminDeleteUser('${u.email}')">Del</button>` : ''}
                        </div>
                    </div>`;
            });
        }
        async function adminDeleteUser(e) { if(confirm("Delete User?")) { await supabase.from('posts').delete().eq('user_email', e); await supabase.from('profiles').delete().eq('email', e); loadAdminUsers(); } }

        // --- PAYMENT USER SIDE ---
        function payForPremium() { window.location.href = `upi://pay?pa=${ADMIN_UPI}&pn=PeaceChatAdmin&am=${GLOBAL_PAY_AMOUNT}&cu=INR`; }
        async function notifyPayment() { const { error } = await supabase.from('payment_requests').insert({ user_email: currentUserEmail, amount: GLOBAL_PAY_AMOUNT, status: 'pending' }); if(!error) { alert("Admin notified!"); document.getElementById('payment-modal').style.display='none'; } else { alert("Error sending notification."); } }

        // --- COMPRESSION & UPLOAD FIX (Improved) ---
        function compressImage(file, callback) {
            const reader = new FileReader(); reader.readAsDataURL(file);
            reader.onload = (e) => {
                const img = new Image(); img.src = e.target.result;
                img.onload = () => {
                    const canvas = document.createElement('canvas'); const ctx = canvas.getContext('2d');
                    const maxWidth = 500; const scaleSize = maxWidth / img.width; // Reduced size for success
                    canvas.width = maxWidth; canvas.height = img.height * scaleSize;
                    ctx.drawImage(img,0,0,canvas.width,canvas.height);
                    callback(canvas.toDataURL('image/jpeg', 0.5)); // 50% Quality
                }
            }
        }
        
        async function uploadCover(input) { 
            if(input.files[0]) {
                document.getElementById('edit-cover-btn').innerHTML = "‚è≥";
                compressImage(input.files[0], async (b64)=>{ 
                    document.getElementById('cover-display').style.backgroundImage=`url(${b64})`;
                    await supabase.from('profiles').update({cover_pic:b64}).eq('email',currentUserEmail);
                    alert("Cover Updated!");
                    document.getElementById('edit-cover-btn').innerHTML = "üì∑ Edit";
                });
            }
        }
        async function uploadDP(input) { 
            if(input.files[0]) {
                document.getElementById('edit-dp-btn').innerHTML = "‚è≥";
                compressImage(input.files[0], async (b64)=>{ 
                    document.getElementById('dp-display').style.backgroundImage=`url(${b64})`;
                    await supabase.from('profiles').update({profile_pic:b64}).eq('email',currentUserEmail);
                    alert("Profile Pic Updated!");
                    document.getElementById('edit-dp-btn').innerHTML = "‚úèÔ∏è";
                });
            }
        }
        function handlePostFile(input) { if(input.files[0]) compressImage(input.files[0], (b64)=>{ postImgBase64=b64; document.getElementById('preview-box').classList.remove('hidden'); document.getElementById('preview-img').src=b64; }); }
        document.getElementById('prodFile').addEventListener('change', function(){ if(this.files[0]) compressImage(this.files[0], (b64)=>{ prodImgBase64=b64; document.getElementById('market-img-status').innerText="Ready!"; }); });

        // ‡¥Ø‡µÇ‡¥∏‡¥±‡µÅ‡¥ü‡µÜ ‡¥™‡µç‡¥∞‡µä‡¥´‡µà‡µΩ ‡¥™‡µá‡¥ú‡µç ‡¥§‡µÅ‡¥±‡¥ï‡µç‡¥ï‡¥æ‡¥®‡µÅ‡¥≥‡µç‡¥≥ ‡¥´‡¥Ç‡¥ó‡µç‡¥∑‡µª (‡¥®‡µá‡¥∞‡¥§‡µç‡¥§‡µÜ ‡¥§‡¥®‡µç‡¥®‡¥ø‡¥∞‡µÅ‡¥®‡µç‡¥® ‡¥ï‡µã‡¥°‡¥ø‡µΩ ‡¥á‡¥§‡µÅ‡¥Ç ‡¥â‡¥£‡µç‡¥ü‡¥æ‡¥Ø‡¥ø‡¥∞‡µÅ‡¥®‡µç‡¥®‡µÅ, ‡¥™‡¥ï‡µç‡¥∑‡µÜ ‡¥á‡¥™‡µç‡¥™‡µã‡µæ ‡¥á‡¥§‡µç ‡¥™‡µä‡¥§‡µÅ‡¥µ‡¥æ‡¥Ø‡¥ø ‡¥â‡¥™‡¥Ø‡µã‡¥ó‡¥ø‡¥ï‡µç‡¥ï‡µÅ‡¥®‡µç‡¥®‡µÅ)
        async function openMyProfile(btn) { 
            if(btn) switchTab('profile', btn); else switchTab('profile', null); 
            loadProfileView(currentUserEmail); 
        }

        // ‡¥™‡µÅ‡¥§‡¥ø‡¥Ø‡¥§‡¥æ‡¥Ø‡¥ø ‡¥ö‡µá‡µº‡¥§‡µç‡¥§ ‡¥´‡¥Ç‡¥ó‡µç‡¥∑‡µª: ‡¥Ö‡¥°‡µç‡¥Æ‡¥ø‡µª ‡¥Ø‡µÇ‡¥∏‡µº ‡¥≤‡¥ø‡¥∏‡µç‡¥±‡µç‡¥±‡¥ø‡µΩ ‡¥®‡¥ø‡¥®‡µç‡¥®‡µç ‡¥Æ‡¥±‡µç‡¥±‡µä‡¥∞‡¥æ‡¥≥‡µÅ‡¥ü‡µÜ ‡¥™‡µç‡¥∞‡µä‡¥´‡µà‡µΩ ‡¥§‡µÅ‡¥±‡¥ï‡µç‡¥ï‡¥æ‡µª
        function openUserProfile(email) { 
            switchTab('profile', null); // ‡¥™‡µç‡¥∞‡µä‡¥´‡µà‡µΩ ‡¥ü‡¥æ‡¥¨‡¥ø‡¥≤‡µá‡¥ï‡µç‡¥ï‡µç ‡¥Æ‡¥æ‡¥±‡µÅ‡¥ï
            loadProfileView(email); // ‡¥§‡¥ø‡¥∞‡¥û‡µç‡¥û‡µÜ‡¥ü‡µÅ‡¥§‡µç‡¥§ ‡¥Ø‡µÇ‡¥∏‡¥±‡µÅ‡¥ü‡µÜ ‡¥™‡µç‡¥∞‡µä‡¥´‡µà‡µΩ ‡¥≤‡µã‡¥°‡µç ‡¥ö‡µÜ‡¥Ø‡µç‡¥Ø‡µÅ‡¥ï
        }

        async function loadProfileView(email) {
            const isMe = (email === currentUserEmail);
            let { data: profile } = await supabase.from('profiles').select('*').eq('email', email).single();
            if (!profile) profile = { email: email, full_name: email.split('@')[0], posts_left: 0 };
            document.getElementById('profile-name').innerText = profile.full_name;
            document.getElementById('cover-display').style.backgroundImage = profile.cover_pic ? `url(${profile.cover_pic})` : 'none';
            document.getElementById('dp-display').style.backgroundImage = profile.profile_pic ? `url(${profile.profile_pic})` : "url('https://via.placeholder.com/100')";
            const msgArea = document.getElementById('admin-message-area'); msgArea.innerHTML = "";
            if(isMe) {
                if (profile.admin_message) { msgArea.innerHTML = `<div class="admin-msg-alert"><span>üì¢ <b>Admin:</b> ${profile.admin_message}</span> <button onclick="dismissAdminMsg()">x</button></div>`; }
                document.getElementById('edit-cover-btn').classList.remove('hidden'); document.getElementById('edit-dp-btn').classList.remove('hidden');
                // --- CHANGED: Used <textarea> instead of <input type="text"> and added height for multiline input ---
                document.getElementById('profile-actions').innerHTML = `<div class="credit-badge">Posts Remaining: ${profile.posts_left || 0}</div><div class="card" style="margin-top:10px; text-align:left;"><b>Create Post</b><textarea id="postInput" class="input-text" style="height: 80px;" placeholder="What's on your mind?"></textarea><div id="preview-box" class="hidden"><img id="preview-img" style="width:100%; border-radius:10px;"></div><div style="display:flex; justify-content:space-between;"><label style="color:#008069; cursor:pointer;">üì∑ <input type="file" id="fileInput" hidden accept="image/*" onchange="handlePostFile(this)"></label><button class="btn-primary" style="width:auto;" onclick="submitPost()">Post</button></div></div>`;
            } else {
                document.getElementById('edit-cover-btn').classList.add('hidden'); document.getElementById('edit-dp-btn').classList.add('hidden');
                document.getElementById('profile-actions').innerHTML = `<button class="btn-primary" onclick="sendFriendRequest('${email}')">Add Friend</button>`;
            }
            loadUserPosts(email); loadUserFriends(email);
        }
        async function dismissAdminMsg() { await supabase.from('profiles').update({ admin_message: null }).eq('email', currentUserEmail); document.getElementById('admin-message-area').innerHTML = ""; }

        async function submitPost() {
            if (currentUserEmail !== ADMIN_EMAIL) {
                let { data: profile } = await supabase.from('profiles').select('posts_left').eq('email', currentUserEmail).single();
                if ((profile?.posts_left || 0) <= 0) { document.getElementById('payment-modal').style.display = 'flex'; return; }
            }
            const content = document.getElementById('postInput').value; if(!content && !postImgBase64) return;
            await supabase.from('posts').insert({ user_email: currentUserEmail, content, image_url: postImgBase64, liked_users: [] });
            if(currentUserEmail !== ADMIN_EMAIL) { let { data: p } = await supabase.from('profiles').select('posts_left').eq('email', currentUserEmail).single(); await supabase.from('profiles').update({ posts_left: (p.posts_left - 1) }).eq('email', currentUserEmail); }
            document.getElementById('postInput').value = ""; postImgBase64 = null; document.getElementById('preview-box').classList.add('hidden'); loadProfileView(currentUserEmail);
        }

        async function renderPost(post, container) {
            let { data: author } = await supabase.from('profiles').select('full_name, profile_pic').eq('email', post.user_email).single();
            const authorName = author?.full_name || post.user_email.split('@')[0];
            const authorPic = author?.profile_pic || 'https://via.placeholder.com/40';
            const imgHTML = post.image_url ? `<img src="${post.image_url}" class="post-img">` : '';
            const likes = post.liked_users || [];
            const canDel = (currentUserEmail === ADMIN_EMAIL) || (currentUserEmail === post.user_email);
            // --- CHANGED: Added class="post-content-text" to the <p> tag ---
            container.innerHTML += `<div class="card"><div class="post-header"><img src="${authorPic}" class="avatar-img" onclick="openUserProfile('${post.user_email}')"><div class="username-link" onclick="openUserProfile('${post.user_email}')" style="margin-left:10px;">${authorName}</div></div><p class="post-content-text">${post.content}</p>${imgHTML}<div class="action-row"><button class="act-btn ${likes.includes(currentUserEmail)?'starred':''}" onclick="toggleStar(${post.id}, '${likes}')">‚≠ê ${likes.length}</button><button class="act-btn" onclick="toggleComments(${post.id})">üí¨ Comment</button>${canDel ? `<button class="act-btn delete" onclick="deletePost(${post.id})">Del</button>` : ''}</div><div id="comments-${post.id}" class="comment-box"><div id="list-${post.id}"></div><div style="display:flex; margin-top:5px; gap:5px;"><input type="text" id="input-${post.id}" class="input-text" style="margin:0;" placeholder="Comment..."><button class="btn-primary" style="width:auto; padding:5px 10px;" onclick="postComment(${post.id})">Send</button></div></div></div>`;
        }
        async function deletePost(id) { if(confirm("Delete?")) { await supabase.from('posts').delete().eq('id', id); loadAll(); } }
        async function loadFeed() { const { data } = await supabase.from('posts').select('*').order('created_at', { ascending: false }); const container = document.getElementById('feed-container'); container.innerHTML = ""; if(data) data.forEach(post => renderPost(post, container)); }
        async function loadUserPosts(email) { const { data } = await supabase.from('posts').select('*').eq('user_email', email).order('created_at', {ascending:false}); const container = document.getElementById('profile-posts-area'); container.innerHTML = ""; if(data) data.forEach(post => renderPost(post, container)); }
        
        async function toggleStar(id, likesStr) { let likes = likesStr?likesStr.split(','):[]; if(likes[0]==="") likes=[]; if(likes.includes(currentUserEmail)) likes=likes.filter(e=>e!==currentUserEmail); else likes.push(currentUserEmail); await supabase.from('posts').update({liked_users:likes}).eq('id',id); loadFeed(); }
        async function toggleComments(id) { const box = document.getElementById(`comments-${id}`); box.style.display = (box.style.display==='block')?'none':'block'; if(box.style.display==='block') loadComments(id); }
        async function postComment(id) { const input = document.getElementById(`input-${id}`); if(!input.value) return; await supabase.from('comments').insert({post_id:id, user_email:currentUserEmail, text:input.value}); input.value=""; loadComments(id); }
        async function loadComments(id) { const {data} = await supabase.from('comments').select('*').eq('post_id',id); const list = document.getElementById(`list-${id}`); list.innerHTML=""; if(data) for (const c of data) { let {data:p} = await supabase.from('profiles').select('full_name').eq('email',c.user_email).single(); list.innerHTML+=`<div><b>${p?.full_name}:</b> ${c.text}</div>`; } }
        async function sendFriendRequest(r) { const { error } = await supabase.from('friend_requests').insert({ sender: currentUserEmail, receiver: r }); if(!error) alert("Sent!"); else alert("Failed/Exists"); }
        async function showFriendRequests() { document.getElementById('req-list-container').classList.remove('hidden'); const { data } = await supabase.from('friend_requests').select('*').eq('receiver', currentUserEmail).eq('status', 'pending'); const div = document.getElementById('req-list-container'); div.innerHTML = "<h3>Requests</h3>"; if(data) for(const r of data) { let {data:s} = await supabase.from('profiles').select('full_name').eq('email',r.sender).single(); div.innerHTML += `<div><b>${s?.full_name}</b> <button onclick="acceptReq(${r.id})">Accept</button></div>`; } }
        async function acceptReq(id) { await supabase.from('friend_requests').update({status:'accepted'}).eq('id',id); alert("Accepted!"); showFriendRequests(); }
        async function loadUserFriends(email) { const grid = document.getElementById('profile-friends-list'); grid.innerHTML=""; const { data } = await supabase.from('friend_requests').select('*').or(`sender.eq.${email},receiver.eq.${email}`).eq('status', 'accepted'); if(data) for(const f of data) { const fEmail = (f.sender===email)?f.receiver:f.sender; const { data:p } = await supabase.from('profiles').select('*').eq('email',fEmail).single(); grid.innerHTML+=`<div class="friend-card" onclick="openUserProfile('${fEmail}')"><img src="${p?.profile_pic||''}" class="friend-img"><div class="friend-name">${p?.full_name}</div></div>`; } }
        async function loadMarket() { const { data } = await supabase.from('products').select('*').order('created_at', {ascending:false}); const grid = document.getElementById('market-container'); grid.innerHTML = ""; if(data) data.forEach(p => { const pStr = encodeURIComponent(JSON.stringify(p)); const img = p.image_url || ''; grid.innerHTML += `<div class="product-card" onclick="openProdDetail('${pStr}')"><img src="${img}" class="prod-img"><div style="font-weight:bold; margin-top:5px;">${p.title}</div><div style="color:green;">‚Çπ${p.price}</div></div>`; }); }
        async function openProdDetail(str) { const p = JSON.parse(decodeURIComponent(str)); document.getElementById('modal-img').src = p.image_url || ''; document.getElementById('modal-title').innerText = p.title; document.getElementById('modal-price').innerText = "‚Çπ" + p.price; document.getElementById('modal-desc').innerText = p.description; const nameSpan = document.getElementById('modal-seller-name'); nameSpan.innerText = "Loading..."; let { data: s } = await supabase.from('profiles').select('full_name, phone').eq('email', p.seller).single(); if(s) { nameSpan.innerText = s.full_name; const btn = document.getElementById('whatsapp-btn'); if(s.phone) { let ph = s.phone.replace(/\D/g,''); if(ph.length === 10) ph = "91" + ph; btn.onclick = () => window.open(`https://wa.me/${ph}?text=${encodeURIComponent('Hi, interested in: '+p.title)}`, '_blank'); } else btn.onclick = () => alert("No phone number."); } else nameSpan.innerText = "Unknown"; document.getElementById('product-modal').style.display = 'flex'; }
        function closeProdModal() { document.getElementById('product-modal').style.display = 'none'; }
        async function submitProduct() { const title = document.getElementById('pTitle').value; const price = document.getElementById('pPrice').value; if(!title || !price) return; await supabase.from('products').insert({ title, price, category: document.getElementById('pCategory').value, description: document.getElementById('pDesc').value, image_url: prodImgBase64, seller: currentUserEmail }); alert("Listed!"); prodImgBase64 = null; loadMarket(); }

        function switchTab(id, btn) { document.querySelectorAll('.page-section').forEach(p => p.classList.remove('active')); document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active')); document.getElementById(id).classList.add('active'); if(btn) btn.classList.add('active'); }
    </script>
</body>
</html>